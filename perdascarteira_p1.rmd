---
title: "Trabalho sobre Perdas em Carteira"
author: "André Camatta"
date: "20 de agosto de 2019"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

# Objetivo

Esse trabalho visa modelar a distribuição de perdas de uma carteira. A primeira parte do trabalho consiste em:

* Realizar o ajuste de distribuiçõess para frequência e severidade.

* Considerar diferentes distribuições para severidade - Gama, LogNormal, Pareto, Inverse Gaussian, etc.
Considerar Poisson e Binomial Negativa para frequência.

* Utilizar o método de máxima verossimilhança para a estivamativa de parâmetros e escolher o melhor ajuste via AIC, teste Kolmogov-Smirnov para distribuição contínua ou outros.

# Modelagem da Frequência 

## Carga dos dados de frequência ##
```{r showfreqarq, eval=F}
frequencia.arquivo <- "C:\\Users\\andre\\OneDrive\\Documentos\\
                Atuaria\\TeoriaDoRisco\\perdascarteiras\\1frequencias.txt"
```

```{r runfreqarq, echo=F}
frequencia.arquivo <- "C:\\Users\\andre\\OneDrive\\Documentos\\Atuaria\\TeoriaDoRisco\\perdascarteiras\\1frequencias.txt"
```

```{r freqload}
frequencias.entrada <- read.table(frequencia.arquivo, header=T)
frequencias <- frequencias.entrada[,1]
```

## Estimativa da distribuição de Poisson para a frequência ##

### Maximização da função log de verossimilhança da distribuição de Poisson ###
```{r veropois}
vero.pois <- function(dados,param){
  -sum(log(dpois(dados,param)))
}
estima.num <- nlminb(100,vero.pois,dados=frequencias,lower=0)
lambda<-estima.num$par
lambda
```

### Uso da biblioteca fitdistrplus para máxima verossimilhança da distribuição de Poisson ###
```{r fitpois}
library(fitdistrplus)

summary(frequencias)

fpoisMLE <- fitdist(frequencias, "pois", method="mle")

fpoisMLE

summary(fpoisMLE)
```

É possível observar que o resultado para $\lambda$ é o mesmo.

## Estimativa da distribuição binomial negativa para a frequência ##

### Maximização da função log de verossimilhança da distribuição binomial negativa ###
```{r verobineg}
vero.nbinom <- function(dados,param){
  -sum(log(dnbinom(dados,size=param[1],prob=param[2])))
}
estima.num.nbinom <- nlminb(c(1000,0.5),vero.nbinom,dados=frequencias,lower=c(0,0),upper=c(Inf,1))
estima.num.nbinom$par
```

### Uso da biblioteca fitdistrplus para máxima verossimilhança da distribuição binomial negativa ###
```{r fitnbinom}
fnbinomMLE <- fitdist(frequencias, "nbinom", method="mle")

fnbinomMLE

summary(fnbinomMLE)
```

Nota-se um pequena diferença para o *size* e que foi estimado o parâmetro $\mu$ em vez de *prob*. Porém, é possível obter o valor de *prob* da maneira a seguir para a comparação.

```{r fitnbinom.prob}
prob.nbinomMLE <- fnbinomMLE$estimate["size"]/(fnbinomMLE$estimate["mu"]+fnbinomMLE$estimate["size"])
names(prob.nbinomMLE)<-"prob"
prob.nbinomMLE
```


Nota-se pequena diferença (a partir do quarto dígito significativo) para o valor de *prob*. 



## Análise gráfica da modelagem da frequência ##

### Comparação com a distribuição de Poisson ###
```{r graphpois}
frequencias.df<-data.frame(frequencias)
frequencias.df["sinistros"]<-rep("Sinistros",length(frequencias))
library(ggplot2)
frequencias.boxplot<-ggplot(data = frequencias.df) +
  geom_boxplot(aes(x = sinistros, y = frequencias)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(y="Frequência por observação") +
  coord_flip() 

poisson.iqr<-qpois(0.75,lambda)-qpois(0.25,lambda)

frequencias.boxplot + 
  geom_hline(yintercept = lambda, color="red", size=0.5) + 
  geom_hline(yintercept = qpois(0.75,lambda), linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = qpois(0.25,lambda), linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = qpois(0.75,lambda), linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = qpois(0.25,lambda), linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = qpois(0.75,lambda)+1.5*poisson.iqr, linetype="dotdash", color="red", size=0.5) +
  geom_hline(yintercept = qpois(0.25,lambda)-1.5*poisson.iqr, linetype="dotdash", color="red", size=0.5)
```
A comparação de gráficos dos dados a função de densidade não traria informações relevantes, devido ao pequeno número de pontos de dados (12). Portanto, optou-se por apresentar os dados como um boxplot na horizontal, assim podemos ver os quartis 25% e 75% (limites da caixa) e compará-los com as informações da distribuição de Poisson estimada (linhas em vermelho), assim como outros parâmetros como a mediana. A aproximação parece boa, há uma levíssima assimetria dos dados. Não é simples deduzir do gráfico que o desvio padrão dos dados é maior do que a obtida pela estimativa, mas basta compará-los.

```{r varpois}
sd(frequencias) #Desvio padrão dos dos dados
sqrt(lambda) #Desvio padrão da distr. de Poisson
```

### Comparação com a distribuição binomial negativa ###

```{r graphnbinom}
frequencias2.boxplot<-ggplot(data = frequencias.df) +
  geom_boxplot(aes(x = sinistros, y = frequencias)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(y="Frequência por observação") +
  coord_flip() 

nbinom.size<-fnbinomMLE$estimate["size"]
nbinom.prob<-prob.nbinomMLE
nbinom.p75<-qnbinom(0.75,nbinom.size,nbinom.prob)
nbinom.p25<-qnbinom(0.25,nbinom.size,nbinom.prob)
nbinom.iqr<-nbinom.p75-nbinom.p25

frequencias2.boxplot + 
  geom_hline(yintercept = lambda, color="red", size=0.5) + 
  geom_hline(yintercept = nbinom.p75, linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = nbinom.p25, linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = nbinom.p75, linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = nbinom.p25, linetype="dashed", color="red", size=0.5) +
  geom_hline(yintercept = nbinom.p75+1.5*nbinom.iqr, linetype="dotdash", color="red", size=0.5) +
  geom_hline(yintercept = nbinom.p25-1.5*nbinom.iqr, linetype="dotdash", color="red", size=0.5)
```